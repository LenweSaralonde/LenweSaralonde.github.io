<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>9 o'clock puzzle</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
		}

		form {
			margin: auto;
			width: 640px;
		}

		table {
			border-collapse: collapse;
			margin-bottom: 20px;
			width: 100%
		}

		th,
		td {
			border: 1px solid #ddd;
			padding: 10px;
			text-align: left;
		}

		th {
			background-color: #f4f4f4;
		}

		label {
			display: inline-block;
			width: 100px;
		}

		.bigField {
			width: 290px;
			margin: auto;
			display: block;
		}

		.result {
			white-space: pre-wrap;
			text-align: left;
		}

		.result td {
			max-width: 50%;
		}

		.equal {
			background-color: #00FF00;
			color: #000000;
			width: 290px;
			text-align: center;
			display: inline-block;
		}
	</style>
	<script>

		const KEY_ENGLISH = 'JYPFFQVY';
		const KEY_FRENCH = 'QLEITRRC';

		const charA = 'A'.charCodeAt(0);
		const PHONE_DIGITS = {
			A: 2,
			B: 2,
			C: 2,
			D: 3,
			E: 3,
			F: 3,
			G: 4,
			H: 4,
			I: 4,
			J: 5,
			K: 5,
			L: 5,
			M: 6,
			N: 6,
			O: 6,
			P: 7,
			Q: 7,
			R: 7,
			S: 7,
			T: 8,
			U: 8,
			V: 8,
			W: 9,
			X: 9,
			Y: 9,
			Z: 9,
		}

		function normalize(text) {
			return text
				.normalize("NFD")
				.replace(/[\u0300-\u036f]/g, "")
				.toUpperCase()
				.replace(/\s+/g, ' ')
				.replace(/[^A-Z ]+/g, ' ');
		}

		function getLetterNumAt(str, pos) {
			return str.charCodeAt(pos) - charA;
		}

		function getLetterFromNum(num) {
			return String.fromCharCode((26 + num) % 26 + charA);
		}

		function vigenereDecode(word, key, sign = -1) {
			if (key === '') {
				return word;
			}
			let decoded = ''
			let keyPos = 0;
			for (let i = 0; i < word.length; i++) {
				if (word[i] === ' ') {
					decoded += ' ';
				} else {
					decoded += getLetterFromNum(getLetterNumAt(word, i) + sign * getLetterNumAt(key, keyPos % key.length));
					keyPos++;
				}
			}
			return decoded;
		}

		function vigenereEncode(word, key) {
			return vigenereDecode(word, key, 1);
		}

		function rotate(word, amount, sign = -1) {
			let decoded = ''
			for (let i = 0; i < word.length; i++) {
				if (word[i] === ' ') {
					decoded += ' ';
				} else {
					decoded += getLetterFromNum(getLetterNumAt(word, i) + sign * amount);
				}
			}
			return decoded;
		}

		function arrayToString(arr) {
			return arr.join(' ');
		}

		function calculateInput(word, key) {
			const vig = +document.getElementById('vigenere').value;
			const rot = +document.getElementById('rotate').value;

			let decoded = word;
			if (vig !== 0) {
				for (let i = 0; i < Math.abs(vig); i++) {
					decoded = vigenereDecode(decoded, key, (vig < 0) ? 1 : -1);
				}
			}
			decoded = rotate(decoded, rot);

			return decoded;
		}

		function toASCII(text, modulo = 10) {
			const result = [];
			for (let i = 0; i < text.length; i++) {
				result.push(text.charCodeAt(i) % modulo % 10);
			}
			return result;
		}

		function toLetter(text, modulo = 10) {
			const result = [];
			for (let i = 0; i < text.length; i++) {
				result.push((text.charCodeAt(i) - charA + 1) % modulo % 10);
			}
			return result;
		}

		function toPhoneDigits(text) {
			const result = [];
			for (let i = 0; i < text.length; i++) {
				result.push(PHONE_DIGITS[text[i]]);
			}
			return result;
		}

		function calculate() {
			const inputEnglish = normalize(document.getElementById('input-english').value);
			const inputFrench = normalize(document.getElementById('input-french').value);
			const swap = document.getElementById('swap').checked;
			document.getElementById('input-english').value = inputEnglish;
			document.getElementById('input-french').value = inputFrench;
			const english = inputEnglish.replace(/\s+/g, '');
			const french = inputFrench.replace(/\s+/g, '');

			let resultEnglish = '';
			let resultFrench = '';

			const decodedVigEnglish = swap ? calculateInput(KEY_ENGLISH, english) : calculateInput(english, KEY_ENGLISH);
			const decodedVigFrench = swap ? calculateInput(KEY_FRENCH, french) : calculateInput(french, KEY_FRENCH);
			resultEnglish += "Decoded:\n";
			resultFrench += "Decoded:\n";
			resultEnglish += decodedVigEnglish + "\n";
			resultFrench += decodedVigFrench + "\n";
			if (decodedVigEnglish === decodedVigFrench) {
				const equal = '<span class="equal">EQUAL!</span>';
				resultEnglish += equal + "\n";
				resultFrench += equal + "\n";
			}
			resultEnglish += "\n";
			resultFrench += "\n";

			const asciiEnglish10 = arrayToString(toASCII(decodedVigEnglish, 10));
			const asciiFrench10 = arrayToString(toASCII(decodedVigFrench, 10));
			resultEnglish += "ASCII char modulo 10:\n";
			resultFrench += "ASCII char modulo 10:\n";
			resultEnglish += asciiEnglish10 + "\n";
			resultFrench += asciiFrench10 + "\n";
			if (asciiEnglish10 === asciiFrench10) {
				const equal = '<span class="equal">EQUAL!</span>';
				resultEnglish += equal + "\n";
				resultFrench += equal + "\n";
			}
			resultEnglish += "\n";
			resultFrench += "\n";

			const asciiEnglish17 = arrayToString(toASCII(decodedVigEnglish, 17));
			const asciiFrench17 = arrayToString(toASCII(decodedVigFrench, 17));
			resultEnglish += "ASCII char modulo 17:\n";
			resultFrench += "ASCII char modulo 17:\n";
			resultEnglish += asciiEnglish17 + "\n";
			resultFrench += asciiFrench17 + "\n";
			if (asciiEnglish17 === asciiFrench17) {
				const equal = '<span class="equal">EQUAL!</span>';
				resultEnglish += equal + "\n";
				resultFrench += equal + "\n";
			}
			resultEnglish += "\n";
			resultFrench += "\n";

			const letterEnglish10 = arrayToString(toLetter(decodedVigEnglish, 10));
			const letterFrench10 = arrayToString(toLetter(decodedVigFrench, 10));
			resultEnglish += "Letter modulo 10:\n";
			resultFrench += "Letter modulo 10:\n";
			resultEnglish += letterEnglish10 + "\n";
			resultFrench += letterFrench10 + "\n";
			if (letterEnglish10 === letterFrench10) {
				const equal = '<span class="equal">EQUAL!</span>';
				resultEnglish += equal + "\n";
				resultFrench += equal + "\n";
			}
			resultEnglish += "\n";
			resultFrench += "\n";

			const letterEnglish17 = arrayToString(toLetter(decodedVigEnglish, 17));
			const letterFrench17 = arrayToString(toLetter(decodedVigFrench, 17));
			resultEnglish += "Letter modulo 17:\n";
			resultFrench += "Letter modulo 17:\n";
			resultEnglish += letterEnglish17 + "\n";
			resultFrench += letterFrench17 + "\n";
			if (letterEnglish17 === letterFrench17) {
				const equal = '<span class="equal">EQUAL!</span>';
				resultEnglish += equal + "\n";
				resultFrench += equal + "\n";
			}
			resultEnglish += "\n";
			resultFrench += "\n";


			const phoneEnglish = arrayToString(toPhoneDigits(decodedVigEnglish));
			const phoneFrench = arrayToString(toPhoneDigits(decodedVigFrench));
			resultEnglish += "Phone key digit:\n";
			resultFrench += "Phone key digit:\n";
			resultEnglish += phoneEnglish + "\n";
			resultFrench += phoneFrench + "\n";
			if (phoneEnglish === phoneFrench) {
				const equal = '<span class="equal">EQUAL!</span>';
				resultEnglish += equal + "\n";
				resultFrench += equal + "\n";
			}
			resultEnglish += "\n";
			resultFrench += "\n";

			document.getElementById('result-english').innerHTML = inputEnglish !== '' ? resultEnglish : '';
			document.getElementById('result-french').innerHTML = inputFrench !== '' ? resultFrench : '';
		}
	</script>
</head>

<body>
	<form>
		<h1>9 o'clock cipher puzzle tester</h1>
		<p style="font-size: .9em">
			This simple tool aims to help solving the 9 o'clock step of the infamous
			<a href="https://warcraft.wiki.gg/wiki/Keys_to_Incognitro,_the_Indecipherable_Felcycle#9_o'clock:_Vault" target="_blank" rel="noreferrer nofollow">Incognitro Azeroth secret</a>.<br>
			The theory is this cipher on the cryptic plaque is the key to unlock Ratts' console in Azj-Kahet.<br>
			Even if the cipher is localized, the end result should be the same regardless of the language.<br>
			Josh confirmed that the puzzle works in English and in French.<br></br>
			For any suggestion or question, feel free to contact me on Discord <a href="https://discordapp.com/users/155422574409547776" target="_blank" rel="noreferrer nofollow">@LenweSaralonde</a>.
		</p>
		<table>
			<thead>
				<tr>
					<th>English</th>
					<th>French</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><input type="text" name="input-english" id="input-english" class="bigField" maxlength="20"
							onkeyup="calculate()" onchange="calculate()"></td>
					<td><input type="text" name="input-french" id="input-french" class="bigField" maxlength="20"
							onkeyup="calculate()" onchange="calculate()"></td>
				</tr>
				<tr>
					<td colspan="2">
						<div style="text-align: center">
							<label for="swap" style="width: 100%"><input type="checkbox" id="swap" name="swap" step="1"
									value="1" onkeyup="calculate()" onchange="calculate()"> Swap key and input</label>
						</div><br>
						<label for="vigenere">Vigenere</label>
						× <input type="number" id="vigenere" name="vigenere" step="1" style="width: 50px" value="1"
							onkeyup="calculate()" onchange="calculate()"> <i>Use negative value to encode instead of
							decoding.</i><br><br>
						<label for="rotate">Rotate</label>
						× <input type="number" id="rotate" name="rotate" step="1" style="width: 50px" value="0"
							onkeyup="calculate()" onchange="calculate()"><br><br>
					</td>
				</tr>
				<tr class="result">
					<td id="result-english"></td>
					<td id="result-french"></td>
				</tr>
			</tbody>
		</table>
	</form>
</body>

</html>